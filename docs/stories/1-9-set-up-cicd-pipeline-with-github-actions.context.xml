<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>9</storyId>
    <title>Set Up CI/CD Pipeline with GitHub Actions</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-03</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/1-9-set-up-cicd-pipeline-with-github-actions.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>to create GitHub Actions workflows for automated testing and deployment</iWant>
    <soThat>code changes are automatically tested and deployed to AWS</soThat>
    <tasks>
      <task id="1" title="Create CI workflow for continuous integration" ac="1">
        <subtask>Create `.github/workflows/ci.yml`</subtask>
        <subtask>Configure workflow to run on pull requests and pushes to main</subtask>
        <subtask>Set up matrix strategy for frontend and backend testing</subtask>
        <subtask>Configure Node.js environment for frontend (use Node.js 20.x LTS)</subtask>
        <subtask>Configure Python environment for backend (use Python 3.11+)</subtask>
        <subtask>Add frontend test step: Run `npm test` (Vitest)</subtask>
        <subtask>Add backend test step: Run `pytest` in backend directory</subtask>
        <subtask>Add frontend linting step: Run `npm run lint` (ESLint)</subtask>
        <subtask>Add backend linting step: Run `ruff check` (if available) or configure Ruff</subtask>
        <subtask>Add frontend type checking step: Run `tsc --noEmit` (TypeScript)</subtask>
        <subtask>Add backend type checking step: Run `mypy` (if configured)</subtask>
        <subtask>Configure workflow to fail if any step fails</subtask>
        <subtask>Add workflow status badges to README (optional)</subtask>
      </task>
      <task id="2" title="Create frontend deployment workflow" ac="2">
        <subtask>Create `.github/workflows/deploy-frontend.yml`</subtask>
        <subtask>Configure workflow to run on push to main branch (or manual trigger)</subtask>
        <subtask>Set up Node.js environment</subtask>
        <subtask>Configure AWS credentials using GitHub Secrets</subtask>
        <subtask>Add step to install frontend dependencies: `npm ci`</subtask>
        <subtask>Add step to build frontend: `npm run build`</subtask>
        <subtask>Add step to configure AWS CLI</subtask>
        <subtask>Add step to sync build output to S3 bucket (use `aws s3 sync`)</subtask>
        <subtask>Add step to invalidate CloudFront distribution (use `aws cloudfront create-invalidation`)</subtask>
        <subtask>Configure S3 bucket name from GitHub Secrets or environment variable</subtask>
        <subtask>Configure CloudFront distribution ID from GitHub Secrets or environment variable</subtask>
        <subtask>Add error handling and rollback documentation</subtask>
        <subtask>Document S3 bucket and CloudFront distribution setup requirements</subtask>
      </task>
      <task id="3" title="Create backend deployment workflow" ac="3">
        <subtask>Create `.github/workflows/deploy-backend.yml`</subtask>
        <subtask>Configure workflow to run on push to main branch (or manual trigger)</subtask>
        <subtask>Set up Python environment</subtask>
        <subtask>Configure AWS credentials using GitHub Secrets</subtask>
        <subtask>Add step to install CDK dependencies: `pip install -r requirements.txt` in infrastructure/cdk</subtask>
        <subtask>Add step to install CDK CLI: `npm install -g aws-cdk` (or use CDK Docker image)</subtask>
        <subtask>Add step to configure AWS CLI</subtask>
        <subtask>Add step to deploy Lambda stack: `cdk deploy SpendSense-Lambda-dev` (or use CDK synth + deploy)</subtask>
        <subtask>Add step to verify deployment success</subtask>
        <subtask>Configure environment variables (dev/staging/prod) from GitHub Secrets</subtask>
        <subtask>Add error handling and rollback documentation</subtask>
        <subtask>Document CDK deployment prerequisites (bootstrap, etc.)</subtask>
      </task>
      <task id="4" title="Configure GitHub Secrets for AWS credentials" ac="4">
        <subtask>Document required GitHub Secrets: AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_REGION, S3_BUCKET_NAME, CLOUDFRONT_DISTRIBUTION_ID</subtask>
        <subtask>Create documentation for setting up GitHub Secrets</subtask>
        <subtask>Document IAM policy requirements for GitHub Actions user/role</subtask>
        <subtask>Document how to create IAM user with minimal required permissions</subtask>
        <subtask>Add security best practices (use IAM roles with OIDC if possible)</subtask>
      </task>
      <task id="5" title="Test workflows with test commits" ac="5">
        <subtask>Create test commit to trigger CI workflow</subtask>
        <subtask>Verify CI workflow runs successfully on pull request</subtask>
        <subtask>Verify CI workflow runs successfully on push to main</subtask>
        <subtask>Verify all test steps pass (frontend tests, backend tests)</subtask>
        <subtask>Verify all linting steps pass</subtask>
        <subtask>Verify all type checking steps pass</subtask>
        <subtask>Create test commit to trigger frontend deployment (if applicable)</subtask>
        <subtask>Verify frontend deployment workflow runs successfully</subtask>
        <subtask>Verify frontend assets are uploaded to S3</subtask>
        <subtask>Verify CloudFront invalidation completes</subtask>
        <subtask>Create test commit to trigger backend deployment (if applicable)</subtask>
        <subtask>Verify backend deployment workflow runs successfully</subtask>
        <subtask>Verify Lambda functions are deployed</subtask>
        <subtask>Document any issues encountered and resolutions</subtask>
      </task>
      <task id="6" title="Document deployment process and rollback procedure" ac="3,4">
        <subtask>Create deployment documentation in `.github/` or `docs/` directory</subtask>
        <subtask>Document manual deployment process (if needed)</subtask>
        <subtask>Document rollback procedure for frontend (S3 versioning, CloudFront invalidation)</subtask>
        <subtask>Document rollback procedure for backend (CDK rollback, previous Lambda version)</subtask>
        <subtask>Document branch protection setup (if applicable)</subtask>
        <subtask>Document how to trigger workflows manually (if needed)</subtask>
        <subtask>Document environment-specific deployment (dev/staging/prod)</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">GitHub Actions workflow created for CI: Runs on pull requests and pushes to main, Runs frontend tests (Vitest), Runs backend tests (pytest), Runs linting (ESLint, Ruff), Runs type checking (TypeScript, mypy)</criterion>
    <criterion id="2">GitHub Actions workflow created for frontend deployment: Builds React app with Vite, Uploads to S3 bucket, Invalidates CloudFront distribution</criterion>
    <criterion id="3">GitHub Actions workflow created for backend deployment: Builds Lambda deployment packages, Deploys Lambda functions via SAM or CDK, Updates API Gateway if needed</criterion>
    <criterion id="4">AWS credentials configured in GitHub Secrets</criterion>
    <criterion id="5">Workflows run successfully on test commits</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/epics.md" title="Epics" section="Story 1.9">
        Story 1.9: Set Up CI/CD Pipeline with GitHub Actions. Acceptance criteria include CI workflow, frontend deployment workflow, backend deployment workflow, GitHub Secrets configuration, and workflow testing.
      </doc>
      <doc path="docs/architecture.md" title="Architecture" section="Decision Summary">
        CI/CD: GitHub Actions Latest. Frontend Testing: Vitest + Playwright Latest. Backend Testing: pytest Latest. Frontend Linting: ESLint + Prettier Latest. Backend Linting: Ruff + Black + mypy Latest. Frontend Hosting: S3 + CloudFront Latest. API Deployment: AWS Lambda + API Gateway Latest.
      </doc>
      <doc path="infrastructure/README.md" title="Infrastructure" section="Deployment">
        CDK deployment commands: `cdk deploy SpendSense-Lambda-dev`. CDK requires bootstrap. Infrastructure code at `infrastructure/cdk/`.
      </doc>
      <doc path="docs/stories/1-1-initialize-frontend-project.md" title="Story 1.1" section="Dev Notes">
        Frontend project uses Vitest for testing (`npm test`), ESLint for linting (`npm run lint`), TypeScript for type checking. Build command: `npm run build` (Vite). Frontend project at `spendsense-frontend/`.
      </doc>
      <doc path="docs/stories/1-2-initialize-backend-project.md" title="Story 1.2" section="Dev Notes">
        Backend project uses pytest for testing, requires Python 3.11+. Backend project at `spendsense-backend/`. Dependencies: Backend uses `requirements.txt` for dependencies.
      </doc>
      <doc path="docs/stories/1-3-create-aws-rds-postgresql-database.md" title="Story 1.3" section="Dev Notes">
        Infrastructure: AWS CDK is used for infrastructure as code. CDK Location: Infrastructure code at `infrastructure/cdk/`. Deployment: CDK requires `cdk bootstrap` and uses `cdk deploy` command.
      </doc>
      <doc path="docs/stories/1-6-create-aws-lambda-functions-and-api-gateway.md" title="Story 1.6" section="Dev Notes">
        Lambda Stack: Lambda functions are deployed via CDK stack `SpendSense-Lambda-dev`. API Gateway: API Gateway is configured in Lambda stack.
      </doc>
      <doc path="spendsense-frontend/package.json" title="Frontend Package" section="Scripts">
        Frontend scripts: `npm test` (Vitest), `npm run lint` (ESLint), `npm run build` (Vite build). Frontend uses Node.js dependencies.
      </doc>
      <doc path="spendsense-backend/requirements.txt" title="Backend Requirements" section="Dependencies">
        Backend dependencies: FastAPI, uvicorn, mangum, boto3, pydantic, python-dotenv, pandas, pytz, openai, sqlalchemy, psycopg2-binary, alembic. Python 3.11+ required.
      </doc>
    </docs>
    <code>
      <!-- No existing CI/CD workflow code - this story creates the workflows -->
    </code>
    <dependencies>
      <ecosystem name="github-actions">
        <package name="actions/checkout" version="v4" />
        <package name="actions/setup-node" version="v4" />
        <package name="actions/setup-python" version="v5" />
        <package name="actions/cache" version="v4" />
        <package name="aws-actions/configure-aws-credentials" version="v4" />
      </ecosystem>
      <ecosystem name="node">
        <package name="aws-cdk" version="latest" scope="global" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="platform">GitHub Actions must be used for CI/CD - no other CI/CD platforms</constraint>
    <constraint type="frontend">Frontend tests must use Vitest (already configured in project), linting must use ESLint, type checking must use TypeScript</constraint>
    <constraint type="backend">Backend tests must use pytest, linting must use Ruff (if available), type checking must use mypy (if configured)</constraint>
    <constraint type="deployment">Frontend deployment must use S3 + CloudFront, backend deployment must use AWS CDK (consistent with infrastructure setup)</constraint>
    <constraint type="credentials">AWS credentials must be stored in GitHub Secrets - never hardcode credentials</constraint>
    <constraint type="security">IAM user for GitHub Actions must have minimal required permissions - document IAM policy requirements</constraint>
    <constraint type="workflow">Workflows must fail fast on errors - configure proper error handling</constraint>
    <constraint type="caching">Use caching for dependencies (npm, pip) to speed up workflow execution</constraint>
    <constraint type="structure">Workflows must be in `.github/workflows/` directory following standard GitHub Actions structure</constraint>
  </constraints>

  <interfaces>
    <!-- No existing interfaces - this story creates the CI/CD workflows -->
  </interfaces>

  <tests>
    <standards>
      CI workflow must run all tests (frontend and backend), linting, and type checking. Workflows must be tested with actual commits to verify they run successfully. Frontend deployment workflow must verify S3 upload and CloudFront invalidation. Backend deployment workflow must verify CDK deployment success.
    </standards>
    <locations>
      <location>.github/workflows/</location>
    </locations>
    <ideas>
      <test ac="1">Verify CI workflow runs on pull request and push to main. Verify all test steps pass (frontend tests, backend tests). Verify all linting steps pass. Verify all type checking steps pass.</test>
      <test ac="2">Verify frontend deployment workflow builds React app successfully. Verify build output is uploaded to S3 bucket. Verify CloudFront invalidation completes successfully.</test>
      <test ac="3">Verify backend deployment workflow installs CDK dependencies. Verify CDK deployment command executes successfully. Verify Lambda functions are deployed via CDK.</test>
      <test ac="4">Verify GitHub Secrets are configured correctly (document verification steps). Verify AWS credentials have required permissions.</test>
      <test ac="5">Verify workflows run successfully on test commits. Verify CI workflow runs on both pull requests and pushes. Verify deployment workflows run on push to main (or manual trigger).</test>
    </ideas>
  </tests>
</story-context>



